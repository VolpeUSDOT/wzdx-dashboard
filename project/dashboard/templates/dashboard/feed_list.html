{% extends 'base.html' %}

{% load humanize %}

{% load humanize_extra %}

{% load static %}

{% load leaflet_tags %}

{% block title %}Home{% endblock %}

{% block head%}
    {% leaflet_js %}
    {% leaflet_css %}
    
    <script>
        function style (feature, latlng) {
            return L.circleMarker(latlng, {
            radius: 8,
            className: 'usa-icon ' + (feature.properties.status_type === "OK" ? 'text-green' : 'text-red'),
            stroke: false,
            fillOpacity: 0.8,
            alt: feature.properties.issuingorganization
            });
        };

        function map_init(map, options) {
            
            {% if bounding_box %}
            const mapBounds = L.latLngBounds([
                {{bounding_box}}
                
            ]);
            map.fitBounds(mapBounds);
            {% endif %}
          
            const layerGroup = L.layerGroup().addTo(map);
          
            async function load_points() {
              const points_url = `/api/points/?in_bbox=${map
                .getBounds()
                .toBBoxString()}`;
              const response = await fetch(points_url);
              const geojson = await response.json();
              return geojson;
            }
          
            async function render_points() {
              const points = await load_points();
              layerGroup.clearLayers();
              L.geoJSON(points, {
                    pointToLayer: style
                })
                .bindPopup((layer) => layer.feature.properties.issuingorganization)
                .addTo(layerGroup);
            }
          
            map.on("moveend", render_points);
          }      
    </script>
{% endblock%}

{% block content %}
<div class="usa-section">
    <div class="grid-container">
        <div class="grid-row grid-gap">
            <main
                class="desktop:grid-col flex-8" id="main-content"
            >
                <div class="usa-table-container--scrollable" tabindex="0">
                    <table class="usa-table usa-table--borderless usa-table--compact">
                        <thead>
                            <tr>
                                <th scope="col">State</th>
                                <th scope="col">Issuing Organization</th>
                                <th scope="col">Status</th>
                                <th scope="col">Detailed Status</th>
                                <th scope="col">Status Since</th>
                                <th scope="col">Update Frequency</th>
                                <th scope="col">Version</th>
                                <th scope="col">Last Pulled</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for feed in feeds %}
                                <tr>
                                    <td>{%if feed.state %}{{ feed.state }}{%else%}N/A{%endif%}</td>
                                    <td>{{ feed.issuingorganization }}</td>
                                    <td class="{% if feed.feed_status.is_error %}text-red{% else %}text-green{% endif %}">{{ feed.feed_status.status_type.label|upper }}</td>
                                    <td>{{ feed.feed_status.details }}</td>
                                    <td>{{ feed.feed_status.status_since|naturaltime }}</td>
                                    <td>{{ feed.datafeed_frequency_update|precisedelta }}</td>
                                    <td>{{ feed.version }}</td>
                                    <td>{{ feed.last_checked|naturaltime }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </main>
            <div class="display-none desktop:display-block desktop:grid-col flex-4">
                {% leaflet_map "points_map_desktop" callback="window.map_init" %}
            </div>
        </div>
        {% if is_paginated%}
            {% include 'components/pagination.html' %}
        {% endif %}
        <div class="desktop:display-none height-mobile">
            {% leaflet_map "points_map_mobile" callback="window.map_init" %}
        </div>
    </div>
</div>
{% endblock %}